<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blockchain Document Sharing: Guide & Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .section-fade-in {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        .section-visible {
            opacity: 1;
            transform: translateY(0);
        }
        .nav-link {
            transition: color 0.3s, border-bottom-color 0.3s;
        }
        .nav-link.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        .architecture-node, .workflow-actor {
            transition: all 0.3s ease-in-out;
        }
        .architecture-node:hover, .workflow-actor:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .highlight-node {
            box-shadow: 0 0 0 3px #3b82f6;
            transform: scale(1.05);
        }
        #workflow-doc {
            position: absolute;
            transition: all 1s ease-in-out;
            z-index: 10;
        }
        .dot-pulse {
            position: relative; left: -9999px; width: 10px; height: 10px; border-radius: 5px; background-color: #3b82f6; color: #3b82f6; box-shadow: 9999px 0 0 -5px; animation: dot-pulse 1.5s infinite linear; animation-delay: .25s;
        }
        .dot-pulse::before, .dot-pulse::after {
            content: ''; display: inline-block; position: absolute; top: 0; width: 10px; height: 10px; border-radius: 5px; background-color: #3b82f6; color: #3b82f6;
        }
        .dot-pulse::before { box-shadow: 9984px 0 0 -5px; animation: dot-pulse-before 1.5s infinite linear; animation-delay: 0s; }
        .dot-pulse::after { box-shadow: 10014px 0 0 -5px; animation: dot-pulse-after 1.5s infinite linear; animation-delay: .5s; }
        @keyframes dot-pulse-before { 0% { box-shadow: 9984px 0 0 -5px; } 30% { box-shadow: 9984px 0 0 2px; } 60%, 100% { box-shadow: 9984px 0 0 -5px; } }
        @keyframes dot-pulse { 0% { box-shadow: 9999px 0 0 -5px; } 30% { box-shadow: 9999px 0 0 2px; } 60%, 100% { box-shadow: 9999px 0 0 -5px; } }
        @keyframes dot-pulse-after { 0% { box-shadow: 10014px 0 0 -5px; } 30% { box-shadow: 10014px 0 0 2px; } 60%, 100% { box-shadow: 10014px 0 0 -5px; } }
        .tab { transition: all 0.3s ease; }
        .tab.active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
        .view { display: none; }
        .view.active { display: block; }
        .btn-primary { background-color: #3b82f6; color: white; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-primary:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .status-log-item { display: flex; align-items: center; padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-size: 0.875rem; transition: all 0.5s ease; opacity: 0; transform: translateY(10px); }
        .status-log-item.visible { opacity: 1; transform: translateY(0); }
        .spinner { border: 2px solid rgba(0,0,0,0.1); width: 16px; height: 16px; border-radius: 50%; border-left-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .key-display { font-family: monospace; background-color: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; }
    </style>
</head>
<body>
    <!-- [Previous HTML content remains exactly the same until the dApp simulation section] -->

    <!-- SECTION 2: DAPP SIMULATION -->
    <section id="simulation" class="pt-12 section-fade-in">
         <div class="w-full max-w-4xl mx-auto">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">dApp File Transfer Simulation</h1>
                <p class="text-gray-600 mt-2">Now, try it yourself. This interactive demo simulates the dApp's front-end, allowing you to perform the file sharing process.</p>
            </header>

            <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex" aria-label="Tabs">
                        <button id="tab-alice" class="tab active w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm">ðŸ‘© Alice (Sender)</button>
                        <button id="tab-bob" class="tab w-1/2 py-4 px-1 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">ðŸ‘¨ Bob (Receiver)</button>
                    </nav>
                </div>

                <div id="view-alice" class="view active p-6 md:p-8">
                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <div id="alice-wallet-disconnected" class="text-center p-6 bg-gray-50 rounded-lg">
                                <h3 class="font-semibold text-gray-800">Connect Your Wallet</h3>
                                <p class="text-sm text-gray-500 mb-4">Connect your MetaMask wallet to manage your documents.</p>
                                <button id="alice-connect-btn" class="btn-primary w-full py-2 rounded-md font-semibold">Connect Wallet</button>
                            </div>
                            <div id="alice-wallet-connected" class="hidden">
                                <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg mb-6">
                                    <div><p class="font-semibold text-green-800">Wallet Connected</p><p id="alice-address" class="text-xs text-green-600 truncate">0x1234...abcd</p></div><span class="text-2xl">âœ…</span>
                                </div>
                                <div class="mb-6">
                                    <h3 class="font-semibold text-gray-800 mb-2">1. Upload a New Document</h3>
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                                        <input type="file" id="file-input" class="hidden"><button id="select-file-btn" class="text-blue-600 font-semibold">Select a file</button><p id="file-name" class="text-sm text-gray-500 mt-1">No file selected.</p>
                                    </div>
                                    <div id="encryption-key-section" class="mt-4 hidden">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Encryption Key</label>
                                        <div class="flex items-center gap-2">
                                            <input type="text" id="encryption-key" class="flex-grow p-2 border border-gray-300 rounded-md" placeholder="Enter a strong passphrase" value="">
                                            <button id="generate-key-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-3 rounded-md text-sm">Generate</button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">This key will be used to encrypt your file. Save it securely!</p>
                                    </div>
                                    <button id="upload-btn" class="btn-primary w-full py-2 mt-4 rounded-md font-semibold" disabled>Upload & Register</button>
                                </div>
                                <div id="grant-access-section" class="hidden">
                                    <h3 class="font-semibold text-gray-800 mb-2">2. Grant Access</h3>
                                    <p class="text-sm text-gray-500 mb-2">Enter the recipient's wallet address to share the document.</p>
                                    <input type="text" id="recipient-address" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Bob's Address: 0x5678...efgh">
                                    <div class="mt-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Share Encryption Key</label>
                                        <div class="flex items-center gap-2">
                                            <input type="text" id="shared-key" class="flex-grow p-2 border border-gray-300 rounded-md bg-gray-100" readonly>
                                            <button id="copy-key-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-3 rounded-md text-sm">Copy</button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">The recipient will need this key to decrypt the file.</p>
                                    </div>
                                    <button id="grant-btn" class="btn-primary w-full py-2 mt-2 rounded-md font-semibold" disabled>Grant Access</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800 mb-2">Activity Log</h3>
                            <div id="alice-status-log" class="h-48 bg-gray-900 text-white rounded-lg p-4 overflow-y-auto font-mono text-xs"><p class="text-gray-400">Awaiting actions...</p></div>
                            <h3 class="font-semibold text-gray-800 mt-6 mb-2">My Documents</h3>
                            <div id="alice-docs-list" class="space-y-2"><p class="text-sm text-gray-500 text-center p-4 bg-gray-50 rounded-lg">No documents uploaded yet.</p></div>
                        </div>
                    </div>
                </div>

                <div id="view-bob" class="view p-6 md:p-8">
                     <div id="bob-wallet-disconnected" class="text-center p-6 bg-gray-50 rounded-lg max-w-md mx-auto">
                        <h3 class="font-semibold text-gray-800">Connect Your Wallet</h3>
                        <p class="text-sm text-gray-500 mb-4">Connect your wallet to see documents shared with you.</p>
                        <button id="bob-connect-btn" class="btn-primary w-full py-2 rounded-md font-semibold">Connect Wallet</button>
                    </div>
                    <div id="bob-wallet-connected" class="hidden">
                         <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg mb-6 max-w-md mx-auto">
                            <div><p class="font-semibold text-green-800">Wallet Connected</p><p id="bob-address" class="text-xs text-green-600 truncate">0x5678...efgh</p></div><span class="text-2xl">âœ…</span>
                        </div>
                        <h3 class="font-semibold text-gray-800 mb-2 text-center">Documents Shared With Me</h3>
                        <div id="bob-docs-list" class="max-w-md mx-auto space-y-2"><p class="text-sm text-gray-500 text-center p-4 bg-gray-50 rounded-lg">No documents have been shared with you yet.</p></div>
                        <div id="bob-decrypt-section" class="max-w-md mx-auto mt-4 hidden">
                            <h4 class="font-semibold text-gray-800 mb-2">Decrypt Document</h4>
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Enter Encryption Key</label>
                                    <input type="text" id="decryption-key" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Paste the key shared with you">
                                </div>
                                <button id="decrypt-btn" class="btn-primary w-full py-2 rounded-md font-semibold">Decrypt & Download</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- [Rest of the HTML content remains exactly the same] -->

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ENCRYPTION/DECRYPTION FUNCTIONS ---
        function generateRandomKey() {
            return CryptoJS.lib.WordArray.random(32).toString();
        }

        function encryptFile(file, key) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const wordArray = CryptoJS.lib.WordArray.create(e.target.result);
                        const encrypted = CryptoJS.AES.encrypt(wordArray, key).toString();
                        resolve(encrypted);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function decryptFile(encryptedData, key) {
            try {
                const decrypted = CryptoJS.AES.decrypt(encryptedData, key);
                return decrypted.toString(CryptoJS.enc.Utf8);
            } catch (error) {
                console.error("Decryption failed:", error);
                return null;
            }
        }

        function simulateIPFSUpload(encryptedData) {
            // In a real app, this would upload to IPFS
            return 'Qm' + CryptoJS.SHA256(encryptedData).toString().substring(0, 44);
        }

        // --- SCRIPT FOR INTERACTIVE GUIDE ---
        // [Previous interactive guide code remains exactly the same]

        // --- SCRIPT FOR DAPP SIMULATION ---
        const dAppState = {
            aliceWalletConnected: false,
            bobWalletConnected: false,
            selectedFile: null,
            uploadedDocument: null,
            accessGranted: false,
            encryptionKey: '',
            aliceAddress: '0x1234567890abcdef1234567890abcdef12345678',
            bobAddress: '0x567890abcdef1234567890abcdef1234567890ab'
        };

        // [Previous DOM element selections remain the same, plus new ones:]
        const encryptionKeySection = document.getElementById('encryption-key-section');
        const encryptionKeyInput = document.getElementById('encryption-key');
        const generateKeyBtn = document.getElementById('generate-key-btn');
        const sharedKeyInput = document.getElementById('shared-key');
        const copyKeyBtn = document.getElementById('copy-key-btn');
        const bobDecryptSection = document.getElementById('bob-decrypt-section');
        const decryptionKeyInput = document.getElementById('decryption-key');
        const decryptBtn = document.getElementById('decrypt-btn');

        // [Previous helper functions like switchDappView, addLog, updateAliceDocs remain the same]

        function updateBobDocs() {
            if (dAppState.accessGranted) {
                const doc = dAppState.uploadedDocument;
                bobDocsList.innerHTML = `
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <p class="font-semibold text-blue-800">${doc.name}</p>
                                <p class="text-xs text-blue-600">From: ${dAppState.aliceAddress.substring(0, 10)}...</p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-700 mb-3">This document has been shared with you. You'll need the encryption key to access it.</p>
                    </div>`;
                bobDecryptSection.classList.remove('hidden');
            } else {
                bobDocsList.innerHTML = '<p class="text-sm text-gray-500 text-center p-4 bg-gray-50 rounded-lg">No documents have been shared with you yet.</p>';
                bobDecryptSection.classList.add('hidden');
            }
        }

        // [Previous event listeners for tabs, wallet connections remain the same]

        selectFileBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                dAppState.selectedFile = e.target.files[0];
                fileNameEl.textContent = dAppState.selectedFile.name;
                encryptionKeySection.classList.remove('hidden');
                if (!encryptionKeyInput.value) {
                    encryptionKeyInput.value = generateRandomKey();
                }
                uploadBtn.disabled = false;
            }
        });

        generateKeyBtn.addEventListener('click', () => {
            encryptionKeyInput.value = generateRandomKey();
        });

        uploadBtn.addEventListener('click', async () => {
            uploadBtn.disabled = true;
            dAppState.encryptionKey = encryptionKeyInput.value;
            
            addLog(aliceStatusLog, 'Encrypting file locally...', 'process');
            try {
                // Simulate encryption process
                await new Promise(res => setTimeout(res, 1500));
                
                addLog(aliceStatusLog, 'Uploading to IPFS...', 'process');
                await new Promise(res => setTimeout(res, 2000));
                
                // In a real app, we would actually encrypt and upload
                const simulatedHash = simulateIPFSUpload("encrypted-data");
                
                dAppState.uploadedDocument = {
                    name: dAppState.selectedFile.name,
                    hash: simulatedHash,
                    encrypted: true
                };
                
                addLog(aliceStatusLog, 'Sending transaction to smart contract...', 'process');
                await new Promise(res => setTimeout(res, 2500));
                
                addLog(aliceStatusLog, `Document registered on blockchain.`, 'success');
                grantAccessSection.classList.remove('hidden');
                sharedKeyInput.value = dAppState.encryptionKey;
                updateAliceDocs();
            } catch (error) {
                addLog(aliceStatusLog, 'Error during file processing: ' + error.message, 'error');
                uploadBtn.disabled = false;
            }
        });

        copyKeyBtn.addEventListener('click', () => {
            sharedKeyInput.select();
            document.execCommand('copy');
            addLog(aliceStatusLog, 'Encryption key copied to clipboard', 'success');
        });

        // [Previous grant access event listener remains the same, but update the success message]
        grantBtn.addEventListener('click', async () => {
            grantBtn.disabled = true;
            const recipient = recipientAddressInput.value.trim();
            if (recipient.toLowerCase() !== dAppState.bobAddress.toLowerCase() && recipient !== "0x5678...efgh") {
                addLog(aliceStatusLog, 'Error: Recipient address does not match Bob\'s.', 'error');
                grantBtn.disabled = false;
                return;
            }
            addLog(aliceStatusLog, 'Preparing access grant transaction...', 'process');
            await new Promise(res => setTimeout(res, 1500));
            addLog(aliceStatusLog, 'Updating smart contract permissions...', 'process');
            await new Promise(res => setTimeout(res, 2000));
            dAppState.accessGranted = true;
            addLog(aliceStatusLog, `Access granted to ${dAppState.bobAddress.substring(0,10)}...`, 'success');
            addLog(aliceStatusLog, `IMPORTANT: Share this key securely: ${dAppState.encryptionKey}`, 'info');
            updateAliceDocs();
            updateBobDocs();
        });

        decryptBtn.addEventListener('click', async () => {
            const key = decryptionKeyInput.value.trim();
            if (!key) {
                addLog(aliceStatusLog, 'Please enter the decryption key', 'error');
                return;
            }
            
            decryptBtn.disabled = true;
            decryptBtn.innerHTML = '<div class="spinner mr-2"></div> Decrypting...';
            
            try {
                // Simulate decryption process
                await new Promise(res => setTimeout(res, 2000));
                
                // In a real app, we would fetch and decrypt the actual file
                const decryptedContent = "Simulated decrypted content of " + dAppState.uploadedDocument.name;
                
                // Create download link
                const blob = new Blob([decryptedContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = dAppState.uploadedDocument.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                addLog(aliceStatusLog, 'Document decrypted and downloaded successfully!', 'success');
            } catch (error) {
                addLog(aliceStatusLog, 'Decryption failed. Please check the key and try again.', 'error');
            } finally {
                decryptBtn.disabled = false;
                decryptBtn.textContent = 'Decrypt & Download';
            }
        });

        // [Rest of the script remains the same]
    });
    </script>
</body>
</html>
